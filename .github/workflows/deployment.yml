name: CI/CD - Deploy Tekoffo (Direct SSH)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create SSH private key from secret
        run: |
          printf '%s\n' "${{ secrets.SSH_ACCESS }}" > ssh_key
          chmod 600 ssh_key

      - name: SSH and Deploy Server
        env:
          SSH_KEY: ssh_key
        run: |
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no sudheerkumarv117@35.184.218.24 << 'EOF'
            set -euo pipefail

            cd ~

            # Clone or pull repo
            if [ -d "tekoffo" ]; then
              echo "Repository exists — pulling latest changes..."
              cd tekoffo
              git pull
            else
              echo "Cloning repository..."
              git clone https://github.com/abhilashvalappil/Tekoffo.git tekoffo
              cd tekoffo
            fi

            # Go to server directory
            cd server

            # Write env file
            echo "${{ secrets.APPLICATION_ENV }}" > .env

            # Install dependencies
            npm install

            # Ensure screen is installed
            if ! command -v screen >/dev/null 2>&1; then
              echo "screen not found — installing..."
              sudo apt-get update -y
              sudo apt-get install -y screen
            fi

            # If a screen session named 'project' exists, stop it
            if screen -list | grep -q "\.project"; then
              echo "Existing 'project' screen session found — stopping it..."
              screen -S project -X quit || true
            fi

            # Start a fresh screen session named 'project' with npm run dev
            echo "Starting new 'project' screen session with 'npm run dev'..."
            screen -dmS project bash -c 'npm run dev'

            echo "✅ Tekoffo deployed successfully (running in screen session 'project')"
          EOF

      - name: Remove SSH key
        if: always()
        run: |
          shred -u ssh_key || rm -f ssh_key || true