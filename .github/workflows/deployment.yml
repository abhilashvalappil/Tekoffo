name: CI/CD - Deploy Tekoffo (Direct SSH)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create SSH private key from secret
        run: |
          printf '%s\n' "${{ secrets.SSH_ACCESS }}" > ssh_key
          chmod 600 ssh_key

      - name: SSH and Deploy Server
        env:
          SSH_KEY: ssh_key
        run: |
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no sudheerkumarv117@35.184.218.24 << 'EOF'
            set -euo pipefail

            cd ~

            # Clone or pull repo
            if [ -d "tekoffo" ]; then
              echo "Repository exists â€” pulling latest changes..."
              cd tekoffo
              git pull
            else
              echo "Cloning repository..."
              git clone https://github.com/abhilashvalappil/Tekoffo.git tekoffo
              cd tekoffo
            fi

            # Go to server directory
            cd server

            # ðŸ”¥ Kill ALL existing screen sessions
            echo "Killing all existing screen sessions..."
            screen -ls | awk '/\t/ {print $1}' | xargs -r screen -S quit || true

            # ðŸš€ Start a new persistent screen session
            echo "Starting persistent screen session 'project'..."
            screen -dmS project bash -c '
              while true; do
                npm run dev
                echo "Process exited â€” restarting in 2 seconds..."
                sleep 2
              done
            '

            echo "ðŸš€ Tekoffo deployed successfully. Persistent screen session 'project' is running."
          EOF

      - name: Remove SSH key
        if: always()
        run: |
          shred -u ssh_key || rm -f ssh_key || true