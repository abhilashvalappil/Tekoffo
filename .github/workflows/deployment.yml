name: CI/CD - Deploy Tekoffo (Direct SSH)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create SSH key
        run: |
          printf '%s\n' "${{ secrets.SSH_ACCESS }}" > ssh_key
          chmod 600 ssh_key

      - name: SSH Deploy
        env:
          SSH_KEY: ssh_key
        run: |
          ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no sudheerkumarv117@35.184.218.24 << 'EOF'
set -euo pipefail

cd ~

if [ -d "tekoffo" ]; then
  cd tekoffo && git pull
else
  git clone https://github.com/abhilashvalappil/Tekoffo.git tekoffo
  cd tekoffo
fi

cd server

pkill -9 -f "SCREEN -dmS project" || true
pkill -9 -f "npm run dev" || true
pkill -9 -f "bash -c while true" || true

screen -wipe >/dev/null 2>&1 || true
sudo rm -rf /run/screen/S-$USER >/dev/null 2>&1 || true

ACTIVE_SCREENS=$(screen -ls 2>&1 | grep -E "Detached|Attached" | wc -l)

if [ "$ACTIVE_SCREENS" -ne 0 ]; then
  echo 'Screen cleanup failed.'
  exit 1
fi

screen -dmS project bash -c '
  while true; do
    npm run dev
    sleep 2
  done
'

echo 'Deployment complete.'
EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          shred -u ssh_key || rm -f ssh_key || true